name: FlatPakBuild

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}
  schedule:
    - cron: "17 3 * * *"  # run daily at 03:17 UTC

jobs:
  check-and-bump:
    name: Check upstream release and bump manifest
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Get latest upstream release (JSON)
        id: latest
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/mitradranirban/fontra-pak-linux/releases/latest"
          json="$(curl -fsSL -H 'Accept: application/vnd.github+json' "$API")"

          tag_name=$(printf '%s' "$json" | jq -r '.tag_name')
          name=$(printf '%s' "$json" | jq -r '.name')
          asset_url=$(printf '%s' "$json" | jq -r '.assets[] | select(.name=="fontrapak.tgz") | .browser_download_url')
          sha256=$(printf '%s' "$json" | jq -r '.assets[] | select(.name=="fontrapak.tgz") | .digest' | sed 's/^sha256://')
          {
            echo "version=$tag_name"
            echo "name=$name"
            echo "asset_url=$asset_url"
            echo "sha256=$sha256"
          } >> "$GITHUB_OUTPUT"


      - name: Read current manifest version
        id: current
        run: |
          set -euo pipefail
          # Extract current version fragment from URL in manifest
          # Assumes URL contains releases/download/<version>/... as in your manifest
          current_version=$(grep -Eo 'releases/download/[^/"]+' xyz.fontra.FontraPak.yml | head -n1 | awk -F/ '{print $3}')
          echo "current_version=$current_version" >> "$GITHUB_OUTPUT"

      - name: Decide if update is needed
        id: gate
        run: |
          set -euo pipefail
          v_up='${{ steps.latest.outputs.version }}'
          v_cur='${{ steps.current.outputs.current_version }}'
          if [ -z "$v_up" ] || [ "$v_up" = "null" ]; then
            echo "No upstream version found; nothing to do."
            echo "update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$v_up" = "$v_cur" ]; then
            echo "Already up-to-date ($v_cur)."
            echo "update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "update=true" >> "$GITHUB_OUTPUT"

      - name: Download new source archive
        if: steps.gate.outputs.update == 'true'
        run: |
          set -euo pipefail
          url='${{ steps.latest.outputs.asset_url }}'
          echo "Downloading: $url"
          curl -fL "$url" -o source.tgz

      - name: Compute SHA256
        if: steps.gate.outputs.update == 'true'
        id: sha
        run: |
          set -euo pipefail
          sha256=$(sha256sum source.tgz | awk '{print $1}')
          echo "sha256=$sha256" >> "$GITHUB_OUTPUT"

      - name: Update manifest file
        if: steps.gate.outputs.update == 'true'
        run: |
          set -euo pipefail
          version='${{ steps.latest.outputs.version }}'
          name='${{ steps.latest.outputs.name }}'
          url='${{ steps.latest.outputs.asset_url }}'
          sha='${{ steps.sha.outputs.sha256 }}'

          # Replace URL and sha256 in the first archive source block
          # URL line
          awk -v new="$url" '
            BEGIN{done=0}
            {if(!done && $0 ~ /type: *archive/){inblk=1}
             if(inblk && $0 ~ /url: /){sub(/url:.*/,"url: " new); done=1; inblk=0}
             print
            }' xyz.fontra.FontraPak.yml > tmp.yml && mv tmp.yml xyz.fontra.FontraPak.yml

          # sha256 line
          awk -v new="$sha" '
            BEGIN{done=0}
            {if(!done && $0 ~ /type: *archive/){inblk=1}
             if(inblk && $0 ~ /sha256: /){sub(/sha256:.*/,"sha256: " new); done=1; inblk=0}
             print
            }' xyz.fontra.FontraPak.yml > tmp.yml && mv tmp.yml xyz.fontra.FontraPak.yml

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add xyz.fontra.FontraPak.yml
          git commit -m "Bump upstream to ${version} (${name}); update source URL and sha256"
          git push

      - name: Create Git Tag and Release
        if: steps.gate.outputs.update == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          version='${{ steps.latest.outputs.version }}'
          # Create/force-update tag matching upstream version
          git fetch --tags
          git tag -f "$version"
          git push --force origin "refs/tags/$version"

          # Create or update release with the same name
          gh release view "$version" >/dev/null 2>&1 && \
            gh release edit "$version" --title "Release $version" --notes "Flatpak manifest updated from upstream release $version" || \
            gh release create "$version" --title "Release $version" --notes "Flatpak manifest updated from upstream release $version"
      - name: Export version for downstream jobs
        if: always()
        run: |
          echo "version=${{ steps.latest.outputs.version || 'manual' }}" >> "$GITHUB_OUTPUT"

  flatpak:
    name: Fontrapak
    needs: [check-and-bump]
    if: needs.check-and-bump.result == 'success'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-25.08
      options: --privileged
    steps:
      - uses: actions/checkout@v6
      - uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: fontra-pak.flatpak
          manifest-path: xyz.fontra.FontraPak.yml
          cache-key: flatpak-builder-${{ github.sha }}
      - name: Upload Flatpak bundle as artifact
        uses: actions/upload-artifact@v5
        with:
          name: fontra-pak-flatpak
          path: fontra-pak.flatpak
          retention-days: 30

  release:
    needs: [flatpak, check-and-bump]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download Flatpak artifact
        uses: actions/download-artifact@v4
        with:
          name: fontra-pak-flatpak
      - name: Create Git Tag
        run: |
          set -euo pipefail
          # Tag is already created in check-and-bump when new release exists.
          echo "No-op."
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-and-bump.outputs.version || 'manual' }}
          name: Release ${{ needs.check-and-bump.outputs.version || 'manual' }}
          body: Flatpak bundle for FontraPak built from upstream release.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Attach Flatpak bundle to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Use latest tag or current commit SHA as fallback
          tag=$(git tag -l --sort=-v:refname | head -n1 || echo "${{ github.sha }}")
          echo "Attaching to: $tag"
          gh release upload "$tag" fontra-pak.flatpak --clobber
