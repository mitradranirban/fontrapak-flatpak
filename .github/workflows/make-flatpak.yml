name: Check for New Release and Build Flatpak

on:
  schedule:
    - cron: "0 6 * * *"  # Run daily at 6 AM UTC
  workflow_dispatch:

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      new-release: ${{ steps.check.outputs.new-release }}
      release-tag: ${{ steps.check.outputs.release-tag }}
      release-url: ${{ steps.check.outputs.release-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new release
        id: check
        run: |
          # Get the latest release from the target repository
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/mitradranirban/fontra-pak-linux/releases/latest)
          LATEST_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
          RELEASE_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url')
          
          echo "Latest release tag: $LATEST_TAG"
          
          # Check if we have a stored last checked tag
          if [ -f "last_checked_release.txt" ]; then
            LAST_CHECKED=$(cat last_checked_release.txt)
            echo "Last checked release: $LAST_CHECKED"
          else
            LAST_CHECKED=""
            echo "No previous release check found"
          fi
          
          # Compare tags
          if [ "$LATEST_TAG" != "$LAST_CHECKED" ] && [ "$LATEST_TAG" != "null" ]; then
            echo "New release found: $LATEST_TAG"
            echo "new-release=true" >> $GITHUB_OUTPUT
            echo "release-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "release-url=$RELEASE_URL" >> $GITHUB_OUTPUT
            
            # Update the last checked release
            echo "$LATEST_TAG" > last_checked_release.txt
          else
            echo "No new release found"
            echo "new-release=false" >> $GITHUB_OUTPUT
            echo "release-tag=" >> $GITHUB_OUTPUT
            echo "release-url=" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated release tag
        if: steps.check.outputs.new-release == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add last_checked_release.txt
          git commit -m "Update last checked release to ${{ steps.check.outputs.release-tag }}" || exit 0
          git push

  build-flatpak:
    runs-on: ubuntu-latest
    needs: check-release
    if: needs.check-release.outputs.new-release == 'true'
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-23.08
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pre-download FontraPak TGZ
        run: |
          mkdir -p ./downloads
          echo "Downloading fontrapak.tgz..."
          curl -L https://github.com/mitradranirban/fontra-pak-linux/releases/latest/download/fontrapak.tgz -o ./downloads/fontrapak.tgz
          echo "Download completed"
          ls -la ./downloads/
        timeout-minutes: 20

      - name: Set up Flatpak repository
        run: |
          echo "Setting up Flatpak repository..."
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08
          echo "Flatpak setup completed"

      - name: Build Flatpak
        run: |
          echo "Starting Flatpak build..."
          # Copy the pre-downloaded tarball to the repository root
          cp ./downloads/fontrapak.tgz ./fontrapak.tgz
